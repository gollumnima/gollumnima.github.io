---
title: "(수정중)허선생님과 함께하는 Maria DB로 데이터 만들기와 Node.js에서 적용"
date: "2019-12-17T11:45:29.169Z"
template: "post"
draft: false
slug: "/posts/nodeJS_4"
category: "node"
tags:
  - "web"
  - "node"
  - "backend"
  - "javascript"
description: "프로젝트 할때 mock-up 데이터 만들려고 json형식의 데이터 파일을 vscode에서 만든 적은 있었는데, 실제 백앤드 데이터 테이블을 만든 적은 없었다! 근데 오늘, 그걸 해냈다! maria DB로 데이터 만들어 본 후기훅이~"
---

![image.png](https://images.velog.io/post-images/dooreplay/026a7750-2155-11ea-b3a3-bb0fc898801e/image.png)

## Maria db 설치하기

`brew install mariadb` 명령어로 설치!

- 서버 시작 : `mysql.server start`
- 서버 멈춤 : `mysql.server stop`
- 실행중인 서버 상태확인 : `mysql.server status`
- 접속 : `mysql -uroot`

### 서버 켜기

![image.png](https://images.velog.io/post-images/dooreplay/e5c632a0-209c-11ea-b574-233afa84a504/image.png)

mysql.server start로 서버 켜주고나서 혹은 mysql만 입력해도 됨<br />
show databases; <- 이때 <b>땀방울 꼭</b> 붙여야 함!<br />
show명령어가 터미널에서 ls와 비슷한 명령어 같은 느낌적인 느낌쓰.. 기존 데이터베이스 목록을 보여준다.

![image.png](https://images.velog.io/post-images/dooreplay/41a5a330-209d-11ea-b574-233afa84a504/image.png)

위 명령어를 통해 내 컴퓨터가 서버가 된건데, 이 서버는 데이터 베이스 여러개 가질 수 있음.
자! 이제 데이터베이스를 한번 만들어보자!

create database 이름; <- 여기도 땀 꼭 붙여야 함. 땀 안 쓰면 문장이 계속 이어지는 줄 앎
나는 데이터베이스 이름을 wecode로 지정했다

![image.png](https://images.velog.io/post-images/dooreplay/b186feb0-209d-11ea-bfea-5d0fa0c4a664/image.png)

database 들어가려면 use wecode
use mysql 입력한 다음에 show tables; 하면 저 목록들이 나옴

![image.png](https://images.velog.io/post-images/dooreplay/0a7fca10-209e-11ea-bfea-5d0fa0c4a664/image.png)

select \* from user;

![image.png](https://images.velog.io/post-images/dooreplay/4fd5ba70-209e-11ea-ac83-7789855e0f19/image.png)

select user,host from user

![image.png](https://images.velog.io/post-images/dooreplay/7563fc70-209e-11ea-ac83-7789855e0f19/image.png)

select 는 CRUD에서 read에 해당되는 것

reate user wecode@localhost identified by 'wecode';

![image.png](https://images.velog.io/post-images/dooreplay/ea55baf0-209e-11ea-bfea-5d0fa0c4a664/image.png)
권한을 부여해야 함.

grant all privileges on wecode.\* to wecode@localhost;
이렇게 권한을 부여하면 관리자권한으로 mysql을 쓰는것
이제 나갈것
exit 해서 나가고

![image.png](https://images.velog.io/post-images/dooreplay/47a66ec0-209f-11ea-bfea-5d0fa0c4a664/image.png)
-user -password 임

![image.png](https://images.velog.io/post-images/dooreplay/638f5c50-209f-11ea-ac83-7789855e0f19/image.png)
이제는 리스트에 mysql이 안 뜨게 됨.
wecode 권한을 가지고 하는것

project로 다시 돌아가서...

`npm i sequelize` 로 이거 깔고
`npm i mariadb`
`npm i dotenv`

sequelize는 ORM => Object Relation Mapping. db의 관계를 객체로 mapping해주는 친구
프로그래밍적인 걸로 sql 쿼리를 대신 날려주는 것.
orm이 없어도 되긴 하는데, 이걸 써야 개발이 편해지는 것. sql은 조금 관계성을 보기엔 이질적이라

mariadb는 connection 관리하는 친구(보통 connector라고 함)
요건 필수! 데이터베이스는 http가 아니기 때문에..! fetch 이런거 못쓰고 별도의 프로토콜을 써야 함. 그걸 관리해주는 애! 손코딩으로 불가..!

dotenv 는 환경변수 관리. 마리아디비에 로그인하는 것. 마리아디비에 사용자랑 비번 만들었으니깐
요청할때마다 사용자명과 암호를 치는 것.
이 정보를 어딘가에 저장을 해야하ㅡㄴ데,
소스코드에 있으면 데이터베이스 암호도 털리니까 별도의 공간에 데이터베이스 로그인 정보를 따로 빼놓는 장치.
개발환경 및 배포환경이 달라야 할때 환경변수를 사용.

1. 프로젝트에 .env파일 만듬

gitignore에 .env 추가

.env 파일에 이렇게 써준다

```
DB_NAME=wecode
DB_USERNAME=wecode
DB_PASSWORD=wecode
```

그담에 server.js 젤 첫줄에다가 이거 한 줄 추가
`require('dotenv').config()`

db.js 파일을 만들어서

```
const Sequelize = require('sequelize')

const sequelize = new Sequelize({
    port: 3306, // database default port
    database: process.env.DB_NAME,
    username: process.env.DB_USERNAME,
    password: process.env.DB_PASSWORD,
    host: 'localhost',
    dialect: 'mariadb'
})
```

ex) post table을 만들었다.
노드 코드 어딘가에다가 문자열로 `SELECT user,~~~ from~~ where~~` 막 이렇게 써야하는데
이걸 자동화해주는게 ORM이댜ㅏ.

이걸 하기위해선 스키마 정의를 해야함.
models라는 폴더를 만들고 거기에 post.js를 만들어줄것임.

sequelize.org 공식문서에 가면 방법이 상세히 나와있음!

```
//post.js

module.exports = (sequelize, types) => {
    return sequelize.define('post', { // 파일명이라 post
      title: {
          type: types.TEXT('tiny'),
          allowNull: false, // 필수라서 Not Null이라고도 함. NN
          defaultValue: '제목없음'
      },
      content: {
          type: types.TEXT,
          allowNull: false,
      },
    }, {
        tableName: 'post',
    })
}
```

이걸 app에서 불러올거임

```
// app.js
// 앞부분 생략쓰
// export한 요소 세개가 db 변수에 들어오는 것.
// 비구조화 할당 가능쓰
// const db = require('./db')
const {  sequelize } = require('./db')

sequelize.sync()
```

이제 서버를 켜면!!

![image.png](https://images.velog.io/post-images/dooreplay/4ee02820-20a4-11ea-9a5b-d1c6e9e9dfde/image.png)

내가 만든 wecode data가 뙇!!! 터미널에 뜬다.

![image.png](https://images.velog.io/post-images/dooreplay/9470c5a0-20a6-11ea-ac83-7789855e0f19/image.png)

![image.png](https://images.velog.io/post-images/dooreplay/a17d60f0-20a6-11ea-bfea-5d0fa0c4a664/image.png)

이제 내용을 담아볼거ㅑㅇ

지난번에 했던 것중 routes폴더에 post.js를 post-json으로 바꿔주곻
index.js에 있는 post들을 다 이름 저렇게 바꿔줌

![image.png](https://images.velog.io/post-images/dooreplay/8caecfd0-20a9-11ea-a776-8f8515dce7b2/image.png)

```
const { post } = require('../db')
// ORM으로 모델 정의한 걸 불러옴
// post 테이블이 어떤 속성을 가지고 있는지, 데이터 사용자명 같은 정보도 다 들어있음

const getAllPost = async (req, res, next)=>{
  // 데이터베이스는 비동기임. 웹서버 바깥에서 자원을 가지고 오는 거락서(node.js 바깥쪽에서 갖고오는거)
    const result = await post.findAll({

  })
  console.log(result, '결과당~~₩')
  res.end()
}


const createPost = async (req, res, next)=>{
  const result = await post.create({
      title: '나는 제목이당',
      content: '나는 내용쓰',
  })
  console.log(result)
  res.end()
}
```

post로 post를 하고 난 후

![image.png](https://images.velog.io/post-images/dooreplay/d1d74790-20a9-11ea-a776-8f8515dce7b2/image.png)
![image.png](https://images.velog.io/post-images/dooreplay/ec3bb800-20a9-11ea-a776-8f8515dce7b2/image.png)

다시 겟을 할꺼임

![image.png](https://images.velog.io/post-images/dooreplay/aa92ad90-20aa-11ea-b8a5-09eea756748a/image.png)

```
const getAllPost = async (req, res, next)=>{
  // 데이터베이스는 비동기임. 웹서버 바깥에서 자원을 가지고 오는 거락서(node.js 바깥쪽에서 갖고오는거)
    const result = await post.findAll({
  }).then(e => JSON.parse(JSON.stringify(e)))
  console.log(result, '결과당~~₩')
  res.end()
}
```

위의 캡쳐임

이번엔 getAllPost

```
const getAllPost = async (req, res, next)=>{

 // 데이터베이스는 비동기임. 웹서버 바깥에서 자원을 가지고 오는 거락서(node.js 바깥쪽에서 갖고오는거)
 const result = await post.findAll({

 }).map(e => e.toJSON())
 res.json({
     data : {
         result
     }
 })
}

```

![image.png](https://images.velog.io/post-images/dooreplay/bb278fd0-20ab-11ea-ae8e-3dc8c4d00eda/image.png)

```
const getAllPost = async (req, res, next)=>{

  try {
    const {
        offset = 1, limit = 20
      } = req.query // 등호 옆에는 기본값 넣어준 것
      const {
          count,
          rows
      } = await post.findAndCountAll({ // 배열에 숫자가 붙어있음.
          offset : parseInt(offset)-1,
          limit : parseInt(limit),
      })
      // 데이터베이스는 비동기임. 웹서버 바깥에서 자원을 가지고 오는 거락서(node.js 바깥쪽에서 갖고오는거)

      const results = rows.map(e => e.toJSON())
      res.json({
          message: '조회함',
          data : { count, results}
      })
  }

  catch(err) {
      next(err)
  }
}

```

이제 겟 날리면

![image.png](https://images.velog.io/post-images/dooreplay/bf9893a0-20ad-11ea-9a7b-bba575039b5c/image.png)

짠 이렇게 나온다!!!!!! 오~

- 비구조화할당 열심히 공부할 것!
- node.js 구조 확실히 공부할 것!
